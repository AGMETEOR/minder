---
version: v1
type: rule-type
name: pr_vulnerability_check
context:
  provider: github
  group: Root Group
description: Verifies that pull requests do not add any vulnerable dependecies
guidance: |
  For every pull request submitted to a repository, this rule will check if the pull request
  adds a new dependency with known vulnerabilities. If it does, the rule will fail and the
  pull request will be rejected or commented on.
def:
  in_entity: pull_request
  rule_schema:
    type: object
    properties:
      action:
        type: string
        description: "The action to take if a vulnerability is found. Can be `review`, `comment`, `commit_status` or `policy_only`."
        enum:
          # mediator will review the PR, suggest changes and mark the PR as changes requested if a vulnerability is found
          - review
          # mediator will comment and suggest changes on the PR if a vulnerability is found. Additionally, mediator
          # will set the commit_status of the PR HEAD to failed to prevent the commit from being merged
          - commit_status
          # mediator will comment and suggest changes on the PR if a vulnerability is found, but not request changes
          - comment
          # the evaluator engine will merely pass on an error, marking the policy as failed if a vulnerability is found
          - policy_only
        default: fail
      ecosystem_config:
        type: array
        description: "The configuration for the ecosystems to check."
        items:
          type: object
          properties:
            name:
              type: string
              description: "The name of the ecosystem to check. Currently only `npm` is supported."
            vulnerability_database_type:
              type: string
              "description": "The kind of vulnerability database to use. Currently only `osv` is supported."
            vulnerability_database_endpoint:
              type: string
              "description": "The endpoint of the vulnerability database to use."
            package_repository:
              type: object
              properties:
                url:
                  type: string
                  description: "The URL of the package repository to use."
              "description": "The package repository to use."
  ingest:
    type: diff
    diff:
      ecosystems:
        - name: npm
          depfile: package-lock.json
  # Defines the configuration for evaluating data ingested against the given policy
  eval:
    type: vulncheck
    vulncheck: {}